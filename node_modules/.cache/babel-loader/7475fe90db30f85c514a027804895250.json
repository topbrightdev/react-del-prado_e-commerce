{"ast":null,"code":"'use strict';\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar qs = require('qs');\n\nvar crypto = require('crypto');\n\nvar hasOwn = function hasOwn(obj, prop) {\n  return Object.prototype.hasOwnProperty.call(obj, prop);\n}; // Certain sandboxed environments (our known example right now are CloudFlare\n// Workers) may make `child_process` unavailable. Because `exec` isn't critical\n// to the operation of stripe-node, we handle this unavailability gracefully.\n\n\nvar exec = null;\n\ntry {\n  exec = require('child_process').exec;\n} catch (e) {\n  if (e.code !== 'MODULE_NOT_FOUND') {\n    throw e;\n  }\n}\n\nvar OPTIONS_KEYS = ['apiKey', 'idempotencyKey', 'stripeAccount', 'apiVersion', 'maxNetworkRetries', 'timeout'];\nvar DEPRECATED_OPTIONS = {\n  api_key: 'apiKey',\n  idempotency_key: 'idempotencyKey',\n  stripe_account: 'stripeAccount',\n  stripe_version: 'apiVersion',\n  stripeVersion: 'apiVersion'\n};\nvar DEPRECATED_OPTIONS_KEYS = Object.keys(DEPRECATED_OPTIONS);\nvar utils = module.exports = {\n  isOptionsHash: function isOptionsHash(o) {\n    return o && typeof o === 'object' && (OPTIONS_KEYS.some(function (prop) {\n      return hasOwn(o, prop);\n    }) || DEPRECATED_OPTIONS_KEYS.some(function (prop) {\n      return hasOwn(o, prop);\n    }));\n  },\n\n  /**\n   * Stringifies an Object, accommodating nested objects\n   * (forming the conventional key 'parent[child]=value')\n   */\n  stringifyRequestData: function stringifyRequestData(data) {\n    return qs.stringify(data, {\n      serializeDate: function serializeDate(d) {\n        return Math.floor(d.getTime() / 1000);\n      }\n    }) // Don't use strict form encoding by changing the square bracket control\n    // characters back to their literals. This is fine by the server, and\n    // makes these parameter strings easier to read.\n    .replace(/%5B/g, '[').replace(/%5D/g, ']');\n  },\n\n  /**\n   * Outputs a new function with interpolated object property values.\n   * Use like so:\n   *   var fn = makeURLInterpolator('some/url/{param1}/{param2}');\n   *   fn({ param1: 123, param2: 456 }); // => 'some/url/123/456'\n   */\n  makeURLInterpolator: function () {\n    var rc = {\n      '\\n': '\\\\n',\n      '\"': '\\\\\"',\n      \"\\u2028\": \"\\\\u2028\",\n      \"\\u2029\": \"\\\\u2029\"\n    };\n    return function (str) {\n      var cleanString = str.replace(/[\"\\n\\r\\u2028\\u2029]/g, function ($0) {\n        return rc[$0];\n      });\n      return function (outputs) {\n        return cleanString.replace(/\\{([\\s\\S]+?)\\}/g, function ($0, $1) {\n          return encodeURIComponent(outputs[$1] || '');\n        });\n      };\n    };\n  }(),\n  extractUrlParams: function extractUrlParams(path) {\n    var params = path.match(/\\{\\w+\\}/g);\n\n    if (!params) {\n      return [];\n    }\n\n    return params.map(function (param) {\n      return param.replace(/[{}]/g, '');\n    });\n  },\n\n  /**\n   * Return the data argument from a list of arguments\n   *\n   * @param {object[]} args\n   * @returns {object}\n   */\n  getDataFromArgs: function getDataFromArgs(args) {\n    if (!Array.isArray(args) || !args[0] || typeof args[0] !== 'object') {\n      return {};\n    }\n\n    if (!utils.isOptionsHash(args[0])) {\n      return args.shift();\n    }\n\n    var argKeys = Object.keys(args[0]);\n    var optionKeysInArgs = argKeys.filter(function (key) {\n      return OPTIONS_KEYS.includes(key);\n    }); // In some cases options may be the provided as the first argument.\n    // Here we're detecting a case where there are two distinct arguments\n    // (the first being args and the second options) and with known\n    // option keys in the first so that we can warn the user about it.\n\n    if (optionKeysInArgs.length > 0 && optionKeysInArgs.length !== argKeys.length) {\n      emitWarning(\"Options found in arguments (\".concat(optionKeysInArgs.join(', '), \"). Did you mean to pass an options object? See https://github.com/stripe/stripe-node/wiki/Passing-Options.\"));\n    }\n\n    return {};\n  },\n\n  /**\n   * Return the options hash from a list of arguments\n   */\n  getOptionsFromArgs: function getOptionsFromArgs(args) {\n    var opts = {\n      auth: null,\n      headers: {},\n      settings: {}\n    };\n\n    if (args.length > 0) {\n      var arg = args[args.length - 1];\n\n      if (typeof arg === 'string') {\n        opts.auth = args.pop();\n      } else if (utils.isOptionsHash(arg)) {\n        var params = args.pop();\n        var extraKeys = Object.keys(params).filter(function (key) {\n          return !OPTIONS_KEYS.includes(key);\n        });\n\n        if (extraKeys.length) {\n          var nonDeprecated = extraKeys.filter(function (key) {\n            if (!DEPRECATED_OPTIONS[key]) {\n              return true;\n            }\n\n            var newParam = DEPRECATED_OPTIONS[key];\n\n            if (params[newParam]) {\n              throw Error(\"Both '\".concat(newParam, \"' and '\").concat(key, \"' were provided; please remove '\").concat(key, \"', which is deprecated.\"));\n            }\n            /**\n             * TODO turn this into a hard error in a future major version (once we have fixed our docs).\n             */\n\n\n            emitWarning(\"'\".concat(key, \"' is deprecated; use '\").concat(newParam, \"' instead.\"));\n            params[newParam] = params[key];\n          });\n\n          if (nonDeprecated.length) {\n            emitWarning(\"Invalid options found (\".concat(extraKeys.join(', '), \"); ignoring.\"));\n          }\n        }\n\n        if (params.apiKey) {\n          opts.auth = params.apiKey;\n        }\n\n        if (params.idempotencyKey) {\n          opts.headers['Idempotency-Key'] = params.idempotencyKey;\n        }\n\n        if (params.stripeAccount) {\n          opts.headers['Stripe-Account'] = params.stripeAccount;\n        }\n\n        if (params.apiVersion) {\n          opts.headers['Stripe-Version'] = params.apiVersion;\n        }\n\n        if (Number.isInteger(params.maxNetworkRetries)) {\n          opts.settings.maxNetworkRetries = params.maxNetworkRetries;\n        }\n\n        if (Number.isInteger(params.timeout)) {\n          opts.settings.timeout = params.timeout;\n        }\n      }\n    }\n\n    return opts;\n  },\n\n  /**\n   * Provide simple \"Class\" extension mechanism\n   */\n  protoExtend: function protoExtend(sub) {\n    var Super = this;\n    var Constructor = hasOwn(sub, 'constructor') ? sub.constructor : function () {\n      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n        args[_key] = arguments[_key];\n      }\n\n      Super.apply(this, args);\n    }; // This initialization logic is somewhat sensitive to be compatible with\n    // divergent JS implementations like the one found in Qt. See here for more\n    // context:\n    //\n    // https://github.com/stripe/stripe-node/pull/334\n\n    Object.assign(Constructor, Super);\n    Constructor.prototype = Object.create(Super.prototype);\n    Object.assign(Constructor.prototype, sub);\n    return Constructor;\n  },\n\n  /**\n   * Secure compare, from https://github.com/freewil/scmp\n   */\n  secureCompare: function secureCompare(a, b) {\n    a = Buffer.from(a);\n    b = Buffer.from(b); // return early here if buffer lengths are not equal since timingSafeEqual\n    // will throw if buffer lengths are not equal\n\n    if (a.length !== b.length) {\n      return false;\n    } // use crypto.timingSafeEqual if available (since Node.js v6.6.0),\n    // otherwise use our own scmp-internal function.\n\n\n    if (crypto.timingSafeEqual) {\n      return crypto.timingSafeEqual(a, b);\n    }\n\n    var len = a.length;\n    var result = 0;\n\n    for (var i = 0; i < len; ++i) {\n      result |= a[i] ^ b[i];\n    }\n\n    return result === 0;\n  },\n\n  /**\n   * Remove empty values from an object\n   */\n  removeNullish: function removeNullish(obj) {\n    if (typeof obj !== 'object') {\n      throw new Error('Argument must be an object');\n    }\n\n    return Object.keys(obj).reduce(function (result, key) {\n      if (obj[key] != null) {\n        result[key] = obj[key];\n      }\n\n      return result;\n    }, {});\n  },\n\n  /**\n   * Normalize standard HTTP Headers:\n   * {'foo-bar': 'hi'}\n   * becomes\n   * {'Foo-Bar': 'hi'}\n   */\n  normalizeHeaders: function normalizeHeaders(obj) {\n    if (!(obj && typeof obj === 'object')) {\n      return obj;\n    }\n\n    return Object.keys(obj).reduce(function (result, header) {\n      result[utils.normalizeHeader(header)] = obj[header];\n      return result;\n    }, {});\n  },\n\n  /**\n   * Stolen from https://github.com/marten-de-vries/header-case-normalizer/blob/master/index.js#L36-L41\n   * without the exceptions which are irrelevant to us.\n   */\n  normalizeHeader: function normalizeHeader(header) {\n    return header.split('-').map(function (text) {\n      return text.charAt(0).toUpperCase() + text.substr(1).toLowerCase();\n    }).join('-');\n  },\n\n  /**\n   * Determine if file data is a derivative of EventEmitter class.\n   * https://nodejs.org/api/events.html#events_events\n   */\n  checkForStream: function checkForStream(obj) {\n    if (obj.file && obj.file.data) {\n      return obj.file.data instanceof EventEmitter;\n    }\n\n    return false;\n  },\n  callbackifyPromiseWithTimeout: function callbackifyPromiseWithTimeout(promise, callback) {\n    if (callback) {\n      // Ensure callback is called outside of promise stack.\n      return promise.then(function (res) {\n        setTimeout(function () {\n          callback(null, res);\n        }, 0);\n      }, function (err) {\n        setTimeout(function () {\n          callback(err, null);\n        }, 0);\n      });\n    }\n\n    return promise;\n  },\n\n  /**\n   * Allow for special capitalization cases (such as OAuth)\n   */\n  pascalToCamelCase: function pascalToCamelCase(name) {\n    if (name === 'OAuth') {\n      return 'oauth';\n    } else {\n      return name[0].toLowerCase() + name.substring(1);\n    }\n  },\n  emitWarning: emitWarning,\n\n  /**\n   * Node's built in `exec` function sometimes throws outright,\n   * and sometimes has a callback with an error,\n   * depending on the type of error.\n   *\n   * This unifies that interface.\n   */\n  safeExec: function safeExec(cmd, cb) {\n    // Occurs if we couldn't load the `child_process` module, which might\n    // happen in certain sandboxed environments like a CloudFlare Worker.\n    if (utils._exec === null) {\n      cb(new Error('exec not available'), null);\n      return;\n    }\n\n    try {\n      utils._exec(cmd, cb);\n    } catch (e) {\n      cb(e, null);\n    }\n  },\n  // For mocking in tests.\n  _exec: exec,\n  isObject: function isObject(obj) {\n    var type = typeof obj;\n    return (type === 'function' || type === 'object') && !!obj;\n  },\n  // For use in multipart requests\n  flattenAndStringify: function flattenAndStringify(data) {\n    var result = {};\n\n    var step = function step(obj, prevKey) {\n      Object.keys(obj).forEach(function (key) {\n        var value = obj[key];\n        var newKey = prevKey ? \"\".concat(prevKey, \"[\").concat(key, \"]\") : key;\n\n        if (utils.isObject(value)) {\n          if (!Buffer.isBuffer(value) && !value.hasOwnProperty('data')) {\n            // Non-buffer non-file Objects are recursively flattened\n            return step(value, newKey);\n          } else {\n            // Buffers and file objects are stored without modification\n            result[newKey] = value;\n          }\n        } else {\n          // Primitives are converted to strings\n          result[newKey] = String(value);\n        }\n      });\n    };\n\n    step(data);\n    return result;\n  },\n\n  /**\n   * https://stackoverflow.com/a/2117523\n   */\n  uuid4: function uuid4() {\n    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {\n      var r = Math.random() * 16 | 0;\n      var v = c === 'x' ? r : r & 0x3 | 0x8;\n      return v.toString(16);\n    });\n  },\n  validateInteger: function validateInteger(name, n, defaultVal) {\n    if (!Number.isInteger(n)) {\n      if (defaultVal !== undefined) {\n        return defaultVal;\n      } else {\n        throw new Error(\"\".concat(name, \" must be an integer\"));\n      }\n    }\n\n    return n;\n  }\n};\n\nfunction emitWarning(warning) {\n  if (typeof process.emitWarning !== 'function') {\n    return console.warn(\"Stripe: \".concat(warning));\n    /* eslint-disable-line no-console */\n  }\n\n  return process.emitWarning(warning, 'Stripe');\n}","map":null,"metadata":{},"sourceType":"script"}